@model List<FE.Models.QuestionViewModel>
@{
    ViewData["Title"] = "Bài kiểm tra - " + ViewBag.Subject;
    int pageSize = 5;
    int totalQuestions = Model.Count;
    int totalPages = (int)Math.Ceiling(totalQuestions / (double)pageSize);
}

<h3>Bài kiểm tra môn: @ViewBag.Subject</h3>

<div class="row">
    <!-- Cột câu hỏi -->
    <div class="col-md-9">
        <form method="post" asp-action="Submit" id="testForm">
            <input type="hidden" name="subject" value="@ViewBag.Subject" />

            @for (int page = 0; page < totalPages; page++)
            {
                <div class="question-page" style="display:@(page == 0 ? "block" : "none")">
                    @for (int i = page * pageSize; i < Math.Min((page + 1) * pageSize, totalQuestions); i++)
                    {
                        var q = Model[i];
                        <div class="mb-4 question" id="question-@q.Id" data-index="@i">
                            <p><strong>@q.Id. @q.Content</strong></p>

                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="answers[@q.Id]" id="q@q.Id-A" value="A" />
                                <label class="form-check-label" for="q@q.Id-A">@q.OptionA</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="answers[@q.Id]" id="q@q.Id-B" value="B" />
                                <label class="form-check-label" for="q@q.Id-B">@q.OptionB</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="answers[@q.Id]" id="q@q.Id-C" value="C" />
                                <label class="form-check-label" for="q@q.Id-C">@q.OptionC</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="answers[@q.Id]" id="q@q.Id-D" value="D" />
                                <label class="form-check-label" for="q@q.Id-D">@q.OptionD</label>
                            </div>
                        </div>
                    }
                </div>
            }

            <div class="d-flex justify-content-between my-3">
                <button type="button" class="btn btn-secondary" id="prevBtn">Trước</button>
                <button type="button" class="btn btn-secondary" id="nextBtn">Sau</button>
            </div>

            <button type="submit" class="btn btn-success" id="submitBtn">Nộp bài</button>
        </form>
    </div>

    <!-- Cột menu câu hỏi -->
    <div class="col-md-3">
        <div class="card p-3 sticky-top" style="top: 20px;">
            <h5 class="mb-3">Danh sách câu hỏi</h5>
            <div class="d-flex flex-wrap">
                @for (int i = 0; i < Model.Count; i++)
                {
                    var q = Model[i];
                    <button type="button" class="btn btn-outline-primary btn-sm m-1" data-index="@i" onclick="goToQuestion(@q.Id)">
                        @q.Id
                    </button>
                }
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let currentPage = 0;
    const pageSize = 5;
    const totalPages = @totalPages;

    // Phân trang
    function showPage(page) {
        document.querySelectorAll('.question-page').forEach((el, idx) => {
            el.style.display = idx === page ? 'block' : 'none';
        });
        currentPage = page;
        updateNavButtons();
    }

    function updateNavButtons() {
        document.getElementById('prevBtn').disabled = currentPage === 0;
        document.getElementById('nextBtn').disabled = currentPage === totalPages - 1;
    }

    document.getElementById('prevBtn').addEventListener('click', () => {
        if (currentPage > 0) showPage(currentPage - 1);
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
        if (currentPage < totalPages - 1) showPage(currentPage + 1);
    });

    // Chuyển tới câu hỏi khi click menu
    function goToQuestion(id) {
        const el = document.getElementById(`question-${id}`);
        if (!el) return;

        const index = parseInt(el.getAttribute('data-index'));
        const pageIndex = Math.floor(index / pageSize);
        showPage(pageIndex);

        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        el.classList.add('border', 'border-primary', 'p-2', 'rounded');
        setTimeout(() => el.classList.remove('border', 'border-primary', 'p-2', 'rounded'), 1500);

        // highlight nút menu
        document.querySelectorAll('.card .btn').forEach(b => b.classList.remove('btn-primary'));
        const btn = document.querySelector(`.card .btn[data-index='${index}']`);
        if (btn) btn.classList.add('btn-primary');
    }

    // Bắt buộc chọn tất cả câu hỏi trước khi submit
    document.getElementById('testForm').addEventListener('submit', function (e) {
        let questions = document.querySelectorAll('.question');
        let incomplete = false;

        questions.forEach(q => {
            let radios = q.querySelectorAll('input[type="radio"]');
            let checked = Array.from(radios).some(r => r.checked);
            if (!checked) {
                incomplete = true;
                q.classList.add('border', 'border-danger', 'p-2', 'rounded');
                setTimeout(() => q.classList.remove('border', 'border-danger', 'p-2', 'rounded'), 2000);
                q.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });

        if (incomplete) {
            e.preventDefault();
            Swal.fire({
                icon: 'warning',
                title: 'Chưa hoàn thành!',
                text: 'Bạn phải chọn đáp án cho tất cả các câu hỏi trước khi nộp bài.',
                confirmButtonText: 'Ok',
                confirmButtonColor: '#3085d6'
            });
        }
    });


    // Khởi tạo Prev/Next
    updateNavButtons();
</script>
