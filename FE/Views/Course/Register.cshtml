@model FE.Models.RegistrationViewModel
@using System.Text.Json
@{
    var userIdClaim = User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    if (!string.IsNullOrEmpty(userIdClaim))
    {
        Model.UserId = Guid.Parse(userIdClaim);
    }
}

<h2 class="mb-4 text-center text-primary">Đăng ký khóa học</h2>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

<form asp-action="Register" method="post" class="mx-auto shadow-lg p-4 bg-white rounded-4" style="max-width: 500px;">
    <!-- Hidden UserId -->
    <input type="hidden" asp-for="UserId" />

    <!-- Chọn lớp -->
    <div class="mb-3">
        <label asp-for="Grade" class="form-label fw-bold">Chọn lớp</label>
        <select asp-for="Grade" class="form-control" id="GradeSelect" required>
            <option value="">-- Chọn lớp --</option>
            @foreach (var grade in ViewBag.Grades as List<string>)
            {
                <option value="@grade">@grade</option>
            }
        </select>
        <span asp-validation-for="Grade" class="text-danger"></span>
    </div>

    <!-- Chọn mức độ -->
    <div class="mb-3">
        <label asp-for="Level" class="form-label fw-bold">Chọn mức độ</label>
        <select asp-for="Level" class="form-control" id="LevelSelect" required>
            <option value="">-- Chọn mức độ --</option>
            @foreach (var level in ViewBag.Levels as List<string>)
            {
                <option value="@level">@level</option>
            }
        </select>
        <span asp-validation-for="Level" class="text-danger"></span>
    </div>

    <!-- Chọn môn học -->
    <div class="mb-3">
        <label asp-for="CourseId" class="form-label fw-bold">Chọn môn học</label>
        <select asp-for="CourseId" class="form-control" id="CourseSelect" required>
            <option value="">-- Chọn môn học --</option>
            @foreach (var course in ViewBag.Courses as List<FE.Models.CourseViewModel>)
            {
                <option value="@course.Id" data-grade="@course.Grade" data-level="@course.Level">
                    @course.Title
                </option>
            }
        </select>
        <span asp-validation-for="CourseId" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-success w-100 mt-3">Đăng ký</button>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Hiển thị SweetAlert
        const success = @Html.Raw(JsonSerializer.Serialize(TempData["Success"]));
        const error = @Html.Raw(JsonSerializer.Serialize(TempData["Error"]));

        if (success) {
            Swal.fire({
                icon: 'success',
                title: success,
                confirmButtonColor: '#198754'
            });
        }

        if (error) {
            Swal.fire({
                icon: 'error',
                title: 'Đăng ký thất bại',
                text: error
            });
        }

        // Lọc môn học theo lớp và mức độ
        const gradeSelect = document.getElementById('GradeSelect');
        const levelSelect = document.getElementById('LevelSelect');
        const courseSelect = document.getElementById('CourseSelect');
        const allCourses = Array.from(courseSelect.options).slice(1); // bỏ option đầu

        function filterCourses() {
            const selectedGrade = gradeSelect.value;
            const selectedLevel = levelSelect.value;

            courseSelect.innerHTML = '<option value="">-- Chọn môn học --</option>';

            allCourses.forEach(option => {
                const grade = option.getAttribute('data-grade');
                const level = option.getAttribute('data-level');

                if ((!selectedGrade || grade === selectedGrade) &&
                    (!selectedLevel || level === selectedLevel)) {
                    courseSelect.appendChild(option.cloneNode(true));
                }
            });
        }

        gradeSelect.addEventListener('change', filterCourses);
        levelSelect.addEventListener('change', filterCourses);
    </script>
}
