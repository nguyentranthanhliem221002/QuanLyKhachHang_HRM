@{
    ViewData["Title"] = "Manage Courses Page";
}

<h2 class="mb-4">Danh sách khóa học</h2>

<div class="mb-3 d-flex gap-2 flex-wrap">
    <button class="btn btn-success" onclick="openAddModal()">Thêm khóa học</button>

    <input type="text" id="searchCourse" class="form-control w-auto" placeholder="Tìm kiếm theo tên khóa học..." />

    <select id="filterGrade" class="form-select w-auto">
        <option value="">Tất cả lớp</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
    </select>

    <select id="filterLevel" class="form-select w-auto">
        <option value="">Tất cả mức học</option>
        <option value="Trung bình">Trung bình</option>
        <option value="Khá">Khá</option>
        <option value="Giỏi">Giỏi</option>
    </select>

    <select id="filterSubject" class="form-select w-auto">
        <option value="">Tất cả môn học</option>
    </select>
</div>

<table class="table table-bordered table-striped" id="coursesTable">
    <thead class="table-primary">
        <tr>
            <th>#</th>
            <th>Tên khóa học</th>
            <th>Lớp</th>
            <th>Mức học</th>
            <th>Môn học</th>
            <th>Giá</th>
            <th>Mô tả</th>
            <th>Ngày bắt đầu</th>
            <th>Ngày kết thúc</th>
            <th>Thao tác</th>
        </tr>
    </thead>

    <tbody></tbody>
</table>

<!-- Modal Thêm/Sửa khóa học -->
<div class="modal fade" id="courseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm/Sửa khóa học</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="courseForm">
                    <input type="hidden" id="courseId" value="-1" />
                    <div class="mb-3">
                        <label>Tên khóa học</label>
                        <input type="text" id="courseTitle" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Lớp</label>
                        <select id="courseGrade" class="form-select" required>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Mức học</label>
                        <select id="courseLevel" class="form-select" required>
                            <option value="Trung bình">Trung bình</option>
                            <option value="Khá">Khá</option>
                            <option value="Giỏi">Giỏi</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Môn học</label>
                        <select id="courseSubject" class="form-select" required>
                            <option value="">Chọn môn học</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Giá</label>
                        <input type="number" id="courseFee" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Mô tả</label>
                        <textarea id="courseDescription" class="form-control"></textarea>
                    </div>
                    <div class="mb-3 d-flex gap-2">
                        <div>
                            <label>Ngày bắt đầu</label>
                            <input type="date" id="courseStart" class="form-control" />
                        </div>
                        <div>
                            <label>Ngày kết thúc</label>
                            <input type="date" id="courseEnd" class="form-control" />
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Lưu</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const apiUrl = window.API_URL + "/api/course";
        const subjectApiUrl = window.API_URL + "/api/subject";

        const courseSubjectSelect = document.getElementById('courseSubject');
        const filterSubjectSelect = document.getElementById('filterSubject');
        let subjects = [];

        // --- Load danh sách môn học ---
        async function loadSubjects() {
            try {
                subjects = await callApi(subjectApiUrl); // [{ id, name }]
                courseSubjectSelect.innerHTML = '<option value="">Chọn môn học</option>';
                filterSubjectSelect.innerHTML = '<option value="">Tất cả môn học</option>';
                subjects.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    courseSubjectSelect.appendChild(opt);

                    const optFilter = document.createElement('option');
                    optFilter.value = s.id;
                    optFilter.textContent = s.name;
                    filterSubjectSelect.appendChild(optFilter);
                });
            } catch(err) {
                console.error("Lỗi load môn học:", err);
            }
        }

        // --- Hiển thị danh sách khóa học ---
        function renderCourses(list) {
            const tbody = document.querySelector('#coursesTable tbody');
            tbody.innerHTML = '';
            const fragment = document.createDocumentFragment();
            list.forEach((c, index) => {
                const tr = document.createElement('tr');
                const subjectName = subjects.find(s => s.id == c.subjectId)?.name ?? '';
                      const start = c.startDate ? new Date(c.startDate).toLocaleDateString('vi-VN') : '';
                const end = c.endDate ? new Date(c.endDate).toLocaleDateString('vi-VN') : '';

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${c.title}</td>
                    <td>${c.grade}</td>
                    <td>${c.level}</td>
                    <td>${subjectName}</td>
                    <td>${c.fee?.toLocaleString('vi-VN')} đ</td>
                    <td>${c.description ?? ''}</td>
                    <td>${start}</td>
                    <td>${end}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editCourse('${c.id}')">Sửa</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCourse('${c.id}')">Xóa</button>
                    </td>`;

                fragment.appendChild(tr);
            });
            tbody.appendChild(fragment);
        }

        // --- Load khóa học ---
        async function loadCourses() {
            const query = new URLSearchParams({
                search: document.getElementById('searchCourse').value.trim(),
                grade: document.getElementById('filterGrade').value,
                level: document.getElementById('filterLevel').value,
                subject: document.getElementById('filterSubject').value
            });
            try {
                const courses = await callApi(`${apiUrl}?${query.toString()}`);
                renderCourses(courses);
            } catch(err) {
                Swal.fire({ icon: 'error', title: 'Lỗi tải dữ liệu', text: err.message });
            }
        }

        // --- Thêm khóa học ---
        function openAddModal() {
            document.getElementById('courseForm').reset();
            document.getElementById('courseId').value = "-1";
            new bootstrap.Modal(document.getElementById('courseModal')).show();
        }

        // --- Sửa khóa học ---
        async function editCourse(id) {
            try {
                const c = await callApi(`${apiUrl}/${id}`);
                document.getElementById('courseId').value = c.id;
                document.getElementById('courseTitle').value = c.title;
                document.getElementById('courseGrade').value = c.grade;
                document.getElementById('courseLevel').value = c.level;
                document.getElementById('courseSubject').value = c.subjectId;
                document.getElementById('courseFee').value = c.fee;
                document.getElementById('courseDescription').value = c.description;
                if (c.startDate) document.getElementById('courseStart').value = c.startDate.split('T')[0];
                if (c.endDate) document.getElementById('courseEnd').value = c.endDate.split('T')[0];
                new bootstrap.Modal(document.getElementById('courseModal')).show();
            } catch(err) {
                Swal.fire({ icon: 'error', title: 'Không tìm thấy khóa học', text: err.message });
            }
        }

        // --- Xóa khóa học ---
        async function deleteCourse(id) {
            const result = await Swal.fire({
                icon: 'warning',
                title: 'Bạn có chắc muốn xóa?',
                showCancelButton: true,
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy',
                reverseButtons: true
            });
            if(result.isConfirmed){
                try{
                    await callApi(`${apiUrl}/${id}`, "DELETE");
                    loadCourses();
                    Swal.fire({ icon: 'success', title: 'Xóa thành công!', timer:1500, toast:true, position:'top-end', showConfirmButton:false });
                }catch(err){
                    Swal.fire({ icon:'error', title:'Xóa thất bại', text: err.message });
                }
            }
        }

        // --- Submit thêm/sửa ---
        document.getElementById('courseForm').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('courseId').value;
            const payload = {
                Title: document.getElementById('courseTitle').value,
                Grade: document.getElementById('courseGrade').value,
                Level: document.getElementById('courseLevel').value,
                SubjectId: document.getElementById('courseSubject').value,
                Fee: parseFloat(document.getElementById('courseFee').value || '0'),
                Description: document.getElementById('courseDescription').value,
                StartDate: document.getElementById('courseStart').value,
                EndDate: document.getElementById('courseEnd').value
            };
            const method = id && id != "-1" ? "PUT" : "POST";
            const url = id && id != "-1" ? `${apiUrl}/${id}` : apiUrl;
            try{
                await callApi(url, method, payload);
                bootstrap.Modal.getInstance(document.getElementById('courseModal')).hide();
                loadCourses();
                Swal.fire({ icon: 'success', title: id != "-1" ? 'Cập nhật thành công!' : 'Thêm thành công!', timer:1500, toast:true, position:'top-end', showConfirmButton:false });
            }catch(err){
                Swal.fire({ icon:'error', title:'Lưu thất bại', text: err.message });
            }
        });

        // --- Filter / tìm kiếm ---
        ['searchCourse','filterGrade','filterLevel','filterSubject'].forEach(id=>{
            const el = document.getElementById(id);
            const event = id==='searchCourse' ? 'input':'change';
            el.addEventListener(event, loadCourses);
        });

        // --- Load lần đầu ---
        loadSubjects().then(loadCourses);
    </script>
}
