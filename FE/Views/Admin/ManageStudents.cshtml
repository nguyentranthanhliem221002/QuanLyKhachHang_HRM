@{
    ViewData["Title"] = "Manage Students Page";
}

<h2 class="mb-4">Danh sách học viên đăng ký</h2>

<div class="mb-3 d-flex gap-2 flex-wrap">
    <button class="btn btn-success" onclick="addStudent()">Thêm học viên</button>

    <input type="text" id="searchStudent" class="form-control w-auto" placeholder="Tìm kiếm theo tên hoặc email..." />

    <select id="filterGrade" class="form-select w-auto">
        <option value="">Tất cả lớp</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
    </select>

    <select id="filterLevel" class="form-select w-auto">
        <option value="">Tất cả mức học</option>
        <option value="Trung bình">Trung bình</option>
        <option value="Khá">Khá</option>
        <option value="Giỏi">Giỏi</option>
    </select>

    <select id="filterStatus" class="form-select w-auto">
        <option value="">Tất cả trạng thái</option>
        <option value="Pending">Pending</option>
        <option value="Approved">Approved</option>
    </select>
</div>

<table class="table table-bordered table-striped" id="studentsTable">
    <thead class="table-primary">
        <tr>
            <th>#</th>
            <th>Họ và tên</th>
            <th>Email</th>
            <th>Lớp</th>
            <th>Mức học</th>
            <th>Trạng thái</th>
            <th>Thao tác</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Modal Thêm/Sửa học viên -->
<div class="modal fade" id="studentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm/Sửa học viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="studentForm">
                    <input type="hidden" id="stuIndex" value="-1" />

                    <div class="mb-3">
                        <label>Họ và tên</label>
                        <input type="text" id="stuFullName" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Email</label>
                        <input type="email" id="stuEmail" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Số điện thoại</label>
                        <input type="text" id="stuPhone" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Giới tính</label>
                        <select id="stuGender" class="form-select" required>
                            <option value="0">Nam</option>
                            <option value="1">Nữ</option>
                            <option value="2">Khác</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Ngày sinh</label>
                        <input type="date" id="stuDateOfBirth" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Lớp</label>
                        <select id="stuGrade" class="form-select" required>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Mức học</label>
                        <select id="stuLevel" class="form-select" required>
                            <option value="Trung bình">Trung bình</option>
                            <option value="Khá">Khá</option>
                            <option value="Giỏi">Giỏi</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Trạng thái</label>
                        <select id="stuStatus" class="form-select" required>
                            <option value="0">Pending</option>
                            <option value="1">Approved</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-success w-100">Lưu</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ✅ Lấy base API URL từ _Layout.cshtml
        const apiUrl = window.API_URL + "/api/users/students";

        // --- Render bảng học viên ---
        function renderStudents(list) {
            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = '';
            const fragment = document.createDocumentFragment();

            list.forEach((stu, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${stu.fullName}</td>
                    <td>${stu.email}</td>
                    <td>${stu.className || stu.grade}</td>
                    <td>${stu.level || ''}</td>
                    <td>${stu.status == 1 ? "Approved" : "Pending"}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editStudent('${stu.id}')">Sửa</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteStudent('${stu.id}')">Xóa</button>
                    </td>`;
                fragment.appendChild(tr);
            });
            tbody.appendChild(fragment);
        }

        // --- Load danh sách học viên ---
        async function loadStudents() {
            const query = new URLSearchParams({
                search: document.getElementById('searchStudent').value.trim(),
                grade: document.getElementById('filterGrade').value,
                level: document.getElementById('filterLevel').value,
                status: document.getElementById('filterStatus').value
            });

            try {
                const students = await callApi(`${apiUrl}?${query.toString()}`);
                renderStudents(students);
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Lỗi tải dữ liệu', text: err.message });
            }
        }

        // --- Thêm học viên ---
        function addStudent() {
            document.getElementById('studentForm').reset();
            document.getElementById('stuIndex').value = "-1";
            new bootstrap.Modal(document.getElementById('studentModal')).show();
        }

        // --- Sửa học viên ---
        async function editStudent(id) {
            try {
                const stu = await callApi(`${apiUrl}/${id}`);
                document.getElementById('stuIndex').value = stu.id;
                document.getElementById('stuFullName').value = stu.fullName;
                document.getElementById('stuEmail').value = stu.email;
                document.getElementById('stuPhone').value = stu.phone || '';
                document.getElementById('stuGender').value = stu.gender ?? 0;
                document.getElementById('stuDateOfBirth').value = stu.dateOfBirth?.split('T')[0] || '';
                document.getElementById('stuGrade').value = stu.grade || stu.className;
                document.getElementById('stuLevel').value = stu.level || '';
                document.getElementById('stuStatus').value = stu.status ?? 0;
                new bootstrap.Modal(document.getElementById('studentModal')).show();
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Không tìm thấy học viên', text: err.message });
            }
        }

        // --- Xóa học viên ---
        async function deleteStudent(id) {
            const result = await Swal.fire({
                icon: 'warning',
                title: 'Bạn có chắc muốn xóa?',
                showCancelButton: true,
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy',
                reverseButtons: true
            });

            if (result.isConfirmed) {
                try {
                    await callApi(`${apiUrl}/${id}`, "DELETE");
                    loadStudents();
                    Swal.fire({ icon: 'success', title: 'Xóa thành công!', timer: 1500, toast: true, position: 'top-end', showConfirmButton: false });
                } catch (err) {
                    Swal.fire({ icon: 'error', title: 'Xóa thất bại', text: err.message });
                }
            }
        }

        // --- Submit form thêm/sửa ---
        document.getElementById('studentForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('stuIndex').value;

            const stuData = {
                fullName: document.getElementById('stuFullName').value,
                email: document.getElementById('stuEmail').value,
                className: document.getElementById('stuGrade').value,
                enrollmentDate: new Date().toISOString(),
                status: parseInt(document.getElementById('stuStatus').value),
                dateOfBirth: document.getElementById('stuDateOfBirth').value || null
            };

            const method = id && id != "-1" ? "PUT" : "POST";
            const url = id && id != "-1" ? `${apiUrl}/${id}` : apiUrl;

            try {
                await callApi(url, method, stuData);
                bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide();
                loadStudents();
                Swal.fire({
                    icon: 'success',
                    title: id && id != "-1" ? 'Cập nhật thành công!' : 'Thêm thành công!',
                    timer: 1500,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false
                });
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Thao tác thất bại', text: err.message });
            }
        });

        // --- Gắn sự kiện filter + search ---
        ['searchStudent', 'filterGrade', 'filterLevel', 'filterStatus'].forEach(id => {
            const el = document.getElementById(id);
            const event = id === 'searchStudent' ? 'input' : 'change';
            el.addEventListener(event, loadStudents);
        });

        // --- Load lần đầu ---
        loadStudents();
    </script>
}
